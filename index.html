<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Visualizer</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- メニューバー -->
    <nav class="menubar" id="menubar">
        <div class="menu-item" data-menu="file">
            <span class="menu-title">File</span>
            <div class="submenu">
                <div class="submenu-item has-submenu" data-submenu="import">
                    <span>Import</span>
                    <span class="arrow">▶</span>
                    <div class="submenu submenu-right">
                        <div class="submenu-item" id="import-network">Network File</div>
                        <div class="submenu-item" id="import-table">Table File</div>
                    </div>
                </div>
                <div class="submenu-item has-submenu" data-submenu="export">
                    <span>Export</span>
                    <span class="arrow">▶</span>
                    <div class="submenu submenu-right">
                        <div class="submenu-item" id="export-network-webpage">Network to Web Page</div>
                    </div>
                </div>
                <div class="submenu-separator"></div>
                <div class="submenu-item" id="open-network">Open</div>
                <div class="submenu-item" id="save-as-network">Save</div>
                <div class="submenu-separator"></div>
                <div class="submenu-item" id="close-network">Close</div>
            </div>
        </div>
        <div class="menu-item" data-menu="layout">
            <span class="menu-title">Layout</span>
            <div class="submenu">
                <div class="submenu-item" id="layout-tools">Layout Tools...</div>
                <div class="submenu-item" id="edge-bends">Edge Bends...</div>
                <div class="submenu-item has-submenu" data-submenu="hierarchical">
                    <span>Hierarchical</span>
                    <span class="arrow">▶</span>
                    <div class="submenu submenu-right">
                        <div class="submenu-item" id="layout-dagre">Defaults</div>
                        <div class="submenu-item" id="layout-equal">Equal</div>
                        <div class="submenu-item" id="sort-nodes-az">Sort Nodes (A-Z)</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="menu-item" data-menu="style" id="open-style-panel" role="button" tabindex="0">
            <span class="menu-title">Style</span>
        </div>
        <div class="menu-item" data-menu="view" id="toggle-table-panel" role="button" tabindex="0">
            <span class="menu-title">Table</span>
        </div>
        <div class="menu-item" data-menu="filter">
            <span class="menu-title">Filter</span>
        </div>
        <div class="menu-item" data-menu="annotation" id="open-annotation-panel" role="button" tabindex="0">
            <span class="menu-title">Annotation</span>
        </div>
        <div class="menu-item" data-menu="extensions">
            <span class="menu-title">Extensions</span>
            <div class="submenu">
                <div class="submenu-item" id="path-trace-menu">Path Trace</div>
            </div>
        </div>
        <div class="menu-toolbar">
            <button class="menu-icon-btn" id="history-undo" title="戻る" aria-label="戻る">
                <svg viewBox="0 0 24 24"><path d="M9 6l-5 6 5 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 12h11a5 5 0 1 1 0 10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
            <button class="menu-icon-btn" id="history-redo" title="進む" aria-label="進む">
                <svg viewBox="0 0 24 24"><path d="M15 6l5 6-5 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M20 12H9a5 5 0 1 0 0 10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
        </div>
    </nav>

    <!-- グラフ表示領域 -->
    <div id="cy-container">
        <!-- ネットワーク背景レイヤー -->
        <div id="network-background"></div>
        <!-- 背景用オーバーレイコンテナ -->
        <div id="overlay-container-back"></div>
        <div id="cy"></div>
        <!-- オーバーレイコンテナ（図形・画像用） -->
        <div id="overlay-container"></div>
    </div>

    <!-- カラムマッピングモーダル -->
    <div class="modal-overlay" id="column-mapping-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Column Mapping</h2>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mapping-table-container">
                    <table class="mapping-table" id="mapping-table">
                        <thead>
                            <tr>
                                <th>Column Name</th>
                                <th>Role</th>
                                <th>Data Type</th>
                                <th>Delimiter</th>
                            </tr>
                        </thead>
                        <tbody id="mapping-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                <button class="btn btn-primary" id="modal-import">Import</button>
            </div>
        </div>
    </div>

    <!-- プログレスオーバーレイ -->
    <div class="progress-overlay" id="progress-overlay">
        <div class="spinner"></div>
        <p class="progress-text">Loading...</p>
    </div>

    <!-- Layout Toolsパネル -->
    <div class="layout-tools-panel" id="layout-tools-panel">
        <div class="tools-panel-header">
            <h3>Layout Tools</h3>
            <button class="tools-panel-close" id="layout-tools-close-btn">&times;</button>
        </div>
        <div class="tools-panel-tabs">
            <button class="tools-tab active" data-tab="scale-rotate">Scale / Rotate</button>
            <button class="tools-tab" data-tab="align-distribute">Align / Distribute</button>
        </div>
        <div class="tools-panel-body">
            <!-- Scale / Rotate Tab -->
            <div class="tools-tab-content active" id="scale-rotate-tab">
                <!-- Scale -->
                <div class="tools-section">
                    <h4>Scale</h4>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="scale-axis" value="width" id="scale-width" checked>
                            Width
                        </label>
                        <label>
                            <input type="radio" name="scale-axis" value="height" id="scale-height">
                            Height
                        </label>
                    </div>
                    <div class="slider-wrapper">
                        <div class="slider-ticks">
                            <span class="tick"></span>
                            <span class="tick"></span>
                            <span class="tick"></span>
                            <span class="tick"></span>
                            <span class="tick"></span>
                        </div>
                        <input type="range" id="scale-slider" min="-3" max="3" step="0.1" value="0" class="slider">
                    </div>
                    <div class="slider-labels">
                        <span>1/8x</span>
                        <span>1/4x</span>
                        <span>1x</span>
                        <span>4x</span>
                        <span>8x</span>
                    </div>
                    <div class="value-input-container">
                        <input type="number" id="scale-value-input" value="1.00" step="0.01" min="0.125" max="8" class="value-input">
                    </div>
                </div>
                
                <!-- Rotate -->
                <div class="tools-section">
                    <h4>Rotate</h4>
                    <div class="slider-wrapper">
                        <div class="slider-ticks">
                            <span class="tick"></span>
                            <span class="tick"></span>
                            <span class="tick"></span>
                            <span class="tick"></span>
                            <span class="tick"></span>
                        </div>
                        <input type="range" id="rotate-slider" min="-180" max="180" step="1" value="0" class="slider">
                    </div>
                    <div class="slider-labels">
                        <span>-180°</span>
                        <span>-90°</span>
                        <span>0°</span>
                        <span>90°</span>
                        <span>180°</span>
                    </div>
                    <div class="value-input-container">
                        <input type="number" id="rotate-value-input" value="0" step="1" min="-180" max="180" class="value-input">
                    </div>
                </div>
            </div>

            <!-- Align / Distribute Tab -->
            <div class="tools-tab-content" id="align-distribute-tab">
                <!-- Align -->
                <div class="tools-section">
                    <h4>Align</h4>
                    <div class="icon-button-grid">
                        <button class="icon-btn" id="align-left" title="Align Left">
                            <svg viewBox="0 0 24 24"><line x1="4" y1="4" x2="4" y2="20" stroke="currentColor" stroke-width="2"/><rect x="6" y="6" width="6" height="4" fill="currentColor"/><rect x="6" y="14" width="10" height="4" fill="currentColor"/></svg>
                        </button>
                        <button class="icon-btn" id="align-center-h" title="Align Center Horizontal">
                            <svg viewBox="0 0 24 24"><line x1="12" y1="4" x2="12" y2="20" stroke="currentColor" stroke-width="2"/><rect x="9" y="6" width="6" height="4" fill="currentColor"/><rect x="7" y="14" width="10" height="4" fill="currentColor"/></svg>
                        </button>
                        <button class="icon-btn" id="align-right" title="Align Right">
                            <svg viewBox="0 0 24 24"><line x1="20" y1="4" x2="20" y2="20" stroke="currentColor" stroke-width="2"/><rect x="12" y="6" width="6" height="4" fill="currentColor"/><rect x="8" y="14" width="10" height="4" fill="currentColor"/></svg>
                        </button>
                        <button class="icon-btn" id="align-top" title="Align Top">
                            <svg viewBox="0 0 24 24"><line x1="4" y1="4" x2="20" y2="4" stroke="currentColor" stroke-width="2"/><rect x="6" y="6" width="4" height="6" fill="currentColor"/><rect x="14" y="6" width="4" height="10" fill="currentColor"/></svg>
                        </button>
                        <button class="icon-btn" id="align-center-v" title="Align Center Vertical">
                            <svg viewBox="0 0 24 24"><line x1="4" y1="12" x2="20" y2="12" stroke="currentColor" stroke-width="2"/><rect x="6" y="9" width="4" height="6" fill="currentColor"/><rect x="14" y="7" width="4" height="10" fill="currentColor"/></svg>
                        </button>
                        <button class="icon-btn" id="align-bottom" title="Align Bottom">
                            <svg viewBox="0 0 24 24"><line x1="4" y1="20" x2="20" y2="20" stroke="currentColor" stroke-width="2"/><rect x="6" y="8" width="4" height="10" fill="currentColor"/><rect x="14" y="12" width="4" height="6" fill="currentColor"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Distribute -->
                <div class="tools-section">
                    <h4>Distribute</h4>
                    <div class="icon-button-grid">
                        <button class="icon-btn" id="distribute-h" title="Distribute Horizontally">
                            <svg viewBox="0 0 24 24"><line x1="4" y1="4" x2="4" y2="20" stroke="currentColor" stroke-width="2"/><line x1="20" y1="4" x2="20" y2="20" stroke="currentColor" stroke-width="2"/><rect x="8" y="9" width="3" height="6" fill="currentColor"/><rect x="13" y="9" width="3" height="6" fill="currentColor"/></svg>
                        </button>
                        <button class="icon-btn" id="distribute-v" title="Distribute Vertically">
                            <svg viewBox="0 0 24 24"><line x1="4" y1="4" x2="20" y2="4" stroke="currentColor" stroke-width="2"/><line x1="4" y1="20" x2="20" y2="20" stroke="currentColor" stroke-width="2"/><rect x="9" y="8" width="6" height="3" fill="currentColor"/><rect x="9" y="13" width="6" height="3" fill="currentColor"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Stack -->
                <div class="tools-section">
                    <h4>Stack</h4>
                    <div class="icon-button-grid">
                        <button class="icon-btn" id="stack-v" title="Stack Vertically">
                            <svg viewBox="0 0 24 24"><rect x="7" y="4" width="10" height="4" fill="currentColor"/><rect x="7" y="10" width="10" height="4" fill="currentColor"/><rect x="7" y="16" width="10" height="4" fill="currentColor"/></svg>
                        </button>
                        <button class="icon-btn" id="stack-h" title="Stack Horizontally">
                            <svg viewBox="0 0 24 24"><rect x="4" y="7" width="4" height="10" fill="currentColor"/><rect x="10" y="7" width="4" height="10" fill="currentColor"/><rect x="16" y="7" width="4" height="10" fill="currentColor"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edge Bendsパネル -->
    <div class="edge-bends-panel" id="edge-bends-panel">
        <div class="tools-panel-header">
            <h3>Edge Bends</h3>
            <button class="tools-panel-close" id="edge-bends-close-btn">&times;</button>
        </div>
        <div class="tools-panel-body">
            <!-- Bend Strength -->
            <div class="tools-section">
                <h4>Bend Strength</h4>
                <div class="slider-wrapper">
                    <div class="slider-ticks">
                        <span class="tick"></span>
                        <span class="tick"></span>
                        <span class="tick"></span>
                        <span class="tick"></span>
                        <span class="tick"></span>
                    </div>
                    <input type="range" id="bend-strength-slider" min="0" max="80" step="0.1" value="40" class="slider">
                </div>
                <div class="slider-labels">
                    <span>0</span>
                    <span>20</span>
                    <span>40</span>
                    <span>60</span>
                    <span>80</span>
                </div>
                <div class="value-input-container">
                    <input type="number" id="bend-strength-value" value="40" step="0.1" min="0" max="80" class="value-input">
                </div>
            </div>
        </div>
    </div>

    <!-- Sort Nodes (A-Z)パネル -->
    <div class="sort-nodes-panel" id="sort-nodes-panel">
        <div class="tools-panel-header">
            <h3>Sort Nodes (A-Z)</h3>
            <button class="tools-panel-close" id="sort-nodes-close-btn">&times;</button>
        </div>
        <div class="tools-panel-body">
            <div class="tools-section">
                <h4>Sort Direction</h4>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="sort-axis" value="x-axis" id="sort-x-axis" checked>
                        X-axis (Rows)
                    </label>
                    <label>
                        <input type="radio" name="sort-axis" value="y-axis" id="sort-y-axis">
                        Y-axis (Columns)
                    </label>
                </div>
                <button class="btn btn-primary" id="sort-apply-btn" style="width: 100%; margin-top: 15px;">Apply Sort</button>
            </div>
        </div>
    </div>

    <!-- Table Panel -->
    <div class="table-panel" id="table-panel">
        <div class="table-resize-handle" id="table-resize-handle"></div>
        <div class="table-panel-header">
            <div class="table-tabs">
                <div class="table-tab active" id="node-table-tab">Node Table</div>
                <div class="table-tab" id="edge-table-tab">Edge Table</div>
            </div>
            <div class="table-panel-actions">
                <button class="btn btn-secondary btn-sm" id="table-column-settings-btn">Columns...</button>
                <button class="btn btn-secondary btn-sm table-filter-btn" id="table-filter-apply-btn" title="Apply Table Filter" aria-label="Apply Table Filter">
                    <svg class="table-filter-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2 3h12l-5 6v4l-2 1V9L2 3z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button class="btn btn-secondary btn-sm table-filter-btn" id="table-filter-clear-btn" title="Clear Filters" aria-label="Clear Filters">
                    <svg class="table-filter-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2 3h12l-5 6v4l-2 1V9L2 3z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M5 5l6 6M11 5l-6 6" stroke="#dc2626" stroke-width="1.4" stroke-linecap="round"/>
                    </svg>
                </button>
                <button class="btn-close" id="table-panel-close-btn" title="Close Table Panel">&times;</button>
            </div>
        </div>
        <div class="table-panel-body">
            <div class="table-wrapper">
                <table class="data-table">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Columns Settings Modal -->
    <div class="modal-overlay" id="column-settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Columns Settings</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="column-settings-container">
                    <p style="margin: 0 0 6px 0; font-size: 14px; color: var(--secondary-color);">Select columns to display in the table:</p>
                    <div class="column-checkboxes" id="column-checkboxes">
                        <!-- Checkboxes will be dynamically generated -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="column-settings-cancel">Cancel</button>
                <button class="btn btn-primary" id="column-settings-apply">Apply</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>確認</h2>
                <button class="modal-close" id="confirm-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirm-modal-message"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="confirm-modal-cancel">キャンセル</button>
                <button class="btn btn-primary" id="confirm-modal-ok">OK</button>
            </div>
        </div>
    </div>

    <!-- Three Button Confirm Modal -->
    <div class="modal-overlay" id="three-button-confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>確認</h2>
                <button class="modal-close" id="three-button-confirm-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="three-button-confirm-message"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="three-button-confirm-discard"></button>
                <button class="btn btn-primary" id="three-button-confirm-apply"></button>
            </div>
        </div>
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel" id="filter-panel">
        <div class="filter-panel-header">
            <h3>Filter</h3>
            <button class="filter-panel-close-btn" id="filter-panel-close-btn">&times;</button>
        </div>
        <div class="filter-panel-body">
            <div class="filter-conditions-container" id="filter-conditions-container">
                <!-- Filter conditions will be dynamically generated -->
            </div>
        </div>
        <div class="filter-panel-footer">
            <button class="btn btn-secondary" id="filter-clear-btn">Clear</button>
            <button class="btn btn-primary" id="filter-apply-btn">Apply</button>
        </div>
    </div>

    <!-- Path Trace Panel -->
    <div class="tools-panel" id="path-trace-panel">
        <div class="tools-panel-header">
            <h3>Path Trace</h3>
            <button class="tools-panel-close" id="path-trace-panel-close-btn">&times;</button>
        </div>
        <div class="tools-panel-body">
            <div class="tools-section">
                <p class="path-trace-description">ノード固有の論文IDを起点としたリンクの軌跡を追跡し、ネットワーク上の接続経路を視覚的に強調します。</p>
                <div class="switch-container">
                    <label class="switch-label">
                        <span>Path Trace</span>
                        <label class="switch">
                            <input type="checkbox" id="path-trace-toggle">
                            <span class="switch-slider"></span>
                        </label>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- 隠しファイル入力 -->
    <input type="file" id="file-input-network" accept=".csv" style="display: none;">
    <input type="file" id="file-input-table" accept=".csv" style="display: none;">
    <input type="file" id="file-input-cx2" accept=".cx2" style="display: none;">
    <input type="file" id="file-input-image" accept="image/*" style="display: none;">

    <!-- 外部ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.min.js"></script>

    <!-- アプリケーションモジュール -->
    <script type="module" src="js/app.js"></script>
</body>
</html>
